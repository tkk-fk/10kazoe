<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>ã‹ããˆã¦10ï½œæ•°ãˆã‚‹ç·´ç¿’</title>
  <style>
    :root{
      --bg:#f7fafc; --ink:#0f172a; --muted:#64748b;
      --accent:#22c55e; --accent2:#2563eb;
      --card:#ffffff; --ring:#dbeafe;
      --radius:24px; --shadow:0 10px 28px rgba(0,0,0,.08);
      --gap:12px;

      /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—ã§æ›´æ–°ã™ã‚‹å‹•çš„å€¤ */
      --safeH: 100svh;          /* JSã§ innerHeight ã«ä¸Šæ›¸ã */
      --playH: 60vh;            /* ãƒ—ãƒ¬ã‚¤é ˜åŸŸã®ä¸Šé™é«˜ã•ï¼ˆJSã§èª¿æ•´ï¼‰ */
      --itemFz: 72px;           /* çµµæ–‡å­—ã‚µã‚¤ã‚ºï¼ˆJSã§èª¿æ•´ï¼‰ */
      --nbtnFz: 24px;           /* æ•°å­—ãƒœã‚¿ãƒ³æ–‡å­—ã‚µã‚¤ã‚ºï¼ˆJSã§èª¿æ•´ï¼‰ */
      --nbtnPy: 14px;           /* æ•°å­—ãƒœã‚¿ãƒ³ç¸¦paddingï¼ˆJSã§èª¿æ•´ï¼‰ */
      --gridGap: 8px;           /* ãƒã‚¹é–“ã®éš™é–“ï¼ˆJSã§èª¿æ•´ï¼‰ */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; background: var(--bg); color: var(--ink); -webkit-tap-highlight-color: transparent; }
    body { margin:0; font-family: system-ui, -apple-system, "BIZ UDPGothic", "Hiragino Sans", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif; }
    .wrap { min-height: var(--safeH); display: grid; place-items: center; padding: 16px; overflow: hidden; }
    .app  { width: 100%; max-width: 1100px; }

    .screen { display: none; max-height: calc(var(--safeH) - 32px); overflow: hidden; }
    .screen.active { display: flex; flex-direction: column; gap: calc(var(--gap) * 1.0); }

    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); }

    .title { text-align: center; padding: 24px; }
    .title h1 { font-size: clamp(28px, 5.2vw, 48px); margin: 0 0 8px; font-weight: 800; letter-spacing: .02em; }
    .title p  { margin: 0; color: var(--muted); font-size: clamp(13px, 1.9vw, 17px); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 12px 20px; border-radius: 18px; border: 2px solid transparent;
      font-weight: 800; cursor: pointer; user-select: none;
      transition: transform .06s ease, opacity .15s ease, border-color .15s ease;
      background: var(--accent); color: #fff;
    }
    .btn:active { transform: translateY(1px); }
    .btn.alt { background: #fff; color: #111; border-color: #e5e7eb; box-shadow: var(--shadow); }

    header.gamebar { display: flex; align-items: center; justify-content: space-between; padding: 0 2px; }
    header .info { color: var(--muted); font-size: clamp(12px, 1.9vw, 16px); }

    .stage { padding: 8px; position: relative; }
    .play-area {
      position: relative;
      width: 100%;
      /* æ¨ªå¹…å„ªå…ˆã ã¨é«˜ã•ãŒæº¢ã‚Œã‚‹ãŸã‚ã€max-heightã‚’å„ªå…ˆã—ã¦ç¸®ã‚€ã‚ˆã†ã«ã™ã‚‹ */
      aspect-ratio: 4/3;
      max-height: var(--playH);
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: var(--gridGap);
      margin-inline: auto;
    }
    .cell   { display: flex; align-items: center; justify-content: center; }
    .item   {
      font-size: var(--itemFz);
      line-height: 1;
      filter: grayscale(70%) saturate(90%) brightness(0.95);
      transition: transform .14s ease, filter .14s ease;
      cursor: pointer; user-select: none; touch-action: manipulation;
    }
    .item.on { filter: none; transform: scale(1.08); }
    .item:active { transform: scale(0.96); }

    .overlay {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      pointer-events: none;
    }
    .cele {
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(2px);
      border-radius: 24px; padding: 20px 24px; text-align: center; box-shadow: var(--shadow);
      pointer-events: auto;
    }
    .cele h2 { margin: 0 0 6px; font-size: clamp(22px, 4.0vmin, 36px); color: #166534; }
    .cele p  { margin: 0 0 12px; color: var(--muted); font-size: clamp(12px, 1.8vmin, 16px); }
    .pop { animation: pop .28s ease; }
    @keyframes pop { from { transform: scale(.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .shake { animation: shake .25s linear; }
    @keyframes shake {
      0%,100%{ transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .fx { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .confetti { position: absolute; width: 10px; height: 10px; border-radius: 2px; opacity: 0; animation: fall 700ms ease-out forwards; }
    @keyframes fall {
      0%  { transform: translateY(-10px) scale(1); opacity: 0; }
      20% { opacity: 1; }
      100%{ transform: translateY(80px) rotate(45deg) scale(.9); opacity: 0; }
    }

    .numpad {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
      padding: 2px 2px 8px;
    }
    .nbtn {
      padding: var(--nbtnPy) 0; border-radius: 16px; background: #fff; box-shadow: var(--shadow);
      border: 2px solid transparent; font-weight: 800; font-size: var(--nbtnFz);
      cursor: pointer; user-select: none; touch-action: manipulation;
      transition: transform .06s ease, opacity .15s ease, border-color .15s ease;
      min-height: 40px;
    }
    .nbtn:active { transform: translateY(1px); }
    .nbtn[disabled] { opacity: .6; }

    .result { padding: 28px 20px; text-align: center; }
    .result h2 { margin: 0; font-size: clamp(28px, 5.2vw, 48px); }
    .result p  { margin: 8px 0 0; color: var(--muted); font-size: clamp(13px, 2.0vw, 17px); }

    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* æ¨ªå‘ãæ™‚ã®å¾®èª¿æ•´ï¼ˆã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ï¼‰ */
    @media (orientation: landscape) {
      :root { --gridGap: 6px; }
      .stage { padding: 6px; }
      header.gamebar { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">

      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <section id="screenTitle" class="screen active">
        <div class="title card">
          <h1>ã‹ããˆã¦<span style="color:#16a34a">10</span></h1>
          <p>ãˆã‚‚ã˜ã‚’ ã•ã‚ã£ã¦ ã‹ããˆã‚ˆã†ã€‚ ãŸã ã—ã„ ã‹ãšã‚’ ã—ãŸã® ã™ã†ã˜ã§ ãˆã‚‰ã¶ã‚ˆã€‚</p>
          <div style="margin-top: 16px;">
            <button id="btnStart" class="btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>
        </div>
      </section>

      <!-- ã‚²ãƒ¼ãƒ  -->
      <section id="screenGame" class="screen">
        <header class="gamebar">
          <div class="info">ã‚‚ã‚“ã ã„ <span id="qNow">1</span> / <span id="qTotal">10</span></div>
          <button id="btnQuit" class="btn alt">ã‚„ã‚ã‚‹</button>
        </header>

        <div class="stage card">
          <div id="playArea" class="play-area">
            <div id="fxLayer" class="fx"></div>
          </div>

          <!-- æ­£è§£ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
          <div id="overlay" class="overlay" hidden style="display:none">
            <div id="celeBox" class="cele">
              <h2>ã›ã„ã‹ã„ï¼</h2>
              <p>ã‚ˆã ã‹ããˆã‚‰ã‚ŒãŸã­</p>
              <button id="btnNext" class="btn">ã¤ãã¸ â–¶</button>
            </div>
          </div>
        </div>

        <div id="numPad" class="numpad"></div>
      </section>

      <!-- çµæœï¼ˆã‚¹ã‚³ã‚¢è¡¨ç¤ºãªã—ï¼‰ -->
      <section id="screenResult" class="screen">
        <div class="result card">
          <h2>ãŒã‚“ã°ã£ãŸã­ï¼</h2>
          <p>ã©ã“ã§ã‚‚ ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚ã©ã‚‹ã‚ˆ</p>
        </div>
      </section>

    </div>

    <div id="live" class="sr-only" aria-live="polite"></div>
  </div>

  <script>
  'use strict';

  // ====== çŠ¶æ…‹ ======
  const TOTAL = 10;
  let round = 0;
  let answer = 0;
  let correct = 0;
  let currentEmoji = 'ğŸ…';

  const EMOJI_SET = ['ğŸ…','ğŸŸ','ğŸ¡','ğŸ ','ğŸ¥¦','ğŸŒ±','ğŸ†','ğŸŒ¶ï¸','ğŸŒ½','ğŸ§…','ğŸ ','ğŸ·','ğŸ±','ğŸ¸','ğŸ’','ğŸª¿','ğŸ¦†','ğŸ¦‡','ğŸ','ğŸ','ğŸ¦‹','ğŸª²','ğŸ’©'];

  // ====== DOM ======
  const scrTitle  = document.getElementById('screenTitle');
  const scrGame   = document.getElementById('screenGame');
  const scrResult = document.getElementById('screenResult');

  const qNow   = document.getElementById('qNow');
  const qTotal = document.getElementById('qTotal');
  const playArea = document.getElementById('playArea');
  const fxLayer  = document.getElementById('fxLayer');
  const numPad   = document.getElementById('numPad');
  const overlay  = document.getElementById('overlay');
  const celeBox  = document.getElementById('celeBox');
  const btnNext  = document.getElementById('btnNext');

  const btnStart = document.getElementById('btnStart');
  const btnQuit  = document.getElementById('btnQuit');

  const live  = document.getElementById('live');

  qTotal.textContent = TOTAL;

  // ====== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ ======
  function updateSafeVH(){
    // iOS/Safariå¯¾ç­–ï¼šãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’é™¤ã„ãŸå®Ÿæ¸¬é«˜ã•ã‚’åæ˜ 
    const h = window.innerHeight || document.documentElement.clientHeight || 768;
    document.documentElement.style.setProperty('--safeH', h + 'px');
  }

  function layoutFit(){
    updateSafeVH();

    // ç¾åœ¨ã®ç”»é¢ã«å¿œã˜ã¦ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»æ•°å­—ãƒœã‚¿ãƒ³é«˜ã•ã‚’å–å¾—ã—ã¦ä¸Šé™ã‚’è¨ˆç®—
    const active = scrGame.classList.contains('active') ? scrGame : (scrTitle.classList.contains('active') ? scrTitle : scrResult);

    // ã–ã£ãã‚Šä½™ç™½ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚„ã‚«ãƒ¼ãƒ‰ã®ä½™ ç™½ç­‰ï¼‰
    const marginReserve = 32; // px
    let headerH = 0, numpadH = 0;

    if(active === scrGame){
      const header = active.querySelector('header.gamebar');
      headerH = header ? header.offsetHeight : 0;
      numpadH = numPad ? numPad.offsetHeight : 0;
    }

    const safeH = window.innerHeight || 768;
    // ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ã®ä¸Šé™é«˜ã•ã‚’ç®—å‡ºï¼ˆæœ€ä½ 180pxã€æœ€å¤§ã§å®‰å…¨æ å†…ï¼‰
    const maxH = Math.max(180, safeH - headerH - numpadH - marginReserve - 24);
    document.documentElement.style.setProperty('--playH', maxH + 'px');

    // çµµæ–‡å­—ã¨æ•°å­—ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã‚‚é«˜ã•ã«å¿œã˜ã¦èª¿æ•´
    // ã‚°ãƒªãƒƒãƒ‰ã¯4è¡Œãªã®ã§ã€ä½™è£•ã‚’è¦‹ã¦  playH / 4 * 0.8 ãã‚‰ã„
    const itemFz = Math.max(40, Math.min(96, Math.floor(maxH / 4 * 0.8)));
    document.documentElement.style.setProperty('--itemFz', itemFz + 'px');

    // æ•°å­—ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚µã‚¤ã‚ºã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆå°ã•ã„ç”»é¢ã§ã¯ç¸®å°ï¼‰
    const nbtnFz = Math.max(16, Math.min(28, Math.floor(safeH / 32)));
    const nbtnPy = Math.max(8,  Math.min(16, Math.floor(safeH / 60)));
    document.documentElement.style.setProperty('--nbtnFz', nbtnFz + 'px');
    document.documentElement.style.setProperty('--nbtnPy', nbtnPy + 'px');

    // ãƒã‚¹é–“ã®éš™é–“ã‚‚å¾®èª¿æ•´ï¼ˆé«˜ã•ãŒå°ã•ã„ã»ã©éš™é–“ã‚’æ¸›ã‚‰ã™ï¼‰
    const gap = maxH < 360 ? 4 : (maxH < 520 ? 6 : 8);
    document.documentElement.style.setProperty('--gridGap', gap + 'px');
  }

  window.addEventListener('resize', layoutFit);
  window.addEventListener('orientationchange', ()=>{ setTimeout(layoutFit, 50); });
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') setTimeout(layoutFit, 50); });

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function safeScrollTop(){
    try { window.scrollTo({ top: 0, behavior: 'auto' }); }
    catch { try { window.scrollTo(0,0); } catch(_){} }
  }
  function clamp(n,min,max){ return Math.min(max, Math.max(min, n)); }
  function toSafeInt(n, fallback=0){
    const x = Number(n);
    if(!Number.isFinite(x)) return fallback;
    const i = Math.floor(x);
    return i < 0 ? 0 : i;
  }
  function shuffle(arr){
    for(let i=arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function show(el){
    [scrTitle, scrGame, scrResult].forEach(s => s.classList.remove('active'));
    el.classList.add('active');
    safeScrollTop();
    // ç”»é¢åˆ‡æ›¿å¾Œã«ä¸€åº¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå†è¨ˆç®—
    setTimeout(layoutFit, 0);
  }

  // ====== BGMï¼ˆWeb Audioï¼‰ ======
  class SimpleBGM{
    constructor(){
      this.ctx=null; this.gain=null; this.isOn=false;
      this.tempo=92; this.nextTime=0; this.lookAhead=0.2; this.tid=null;
    }
    ensure(){
      if(!this.ctx){
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.gain = this.ctx.createGain();
        this.gain.gain.value = 0.06;
        this.gain.connect(this.ctx.destination);
        this.nextTime = this.ctx.currentTime + 0.05;
      }
    }
    note(t,f,d=0.18){
      const o=this.ctx.createOscillator(), g=this.ctx.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(f,t);
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(0.5, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+d);
      o.connect(g).connect(this.gain); o.start(t); o.stop(t+d+0.02);
    }
    start(){
      this.ensure();
      if(this.isOn) return;
      this.isOn=true; this.ctx.resume();
      const beat = 60/this.tempo;
      const scale = [261.63, 329.63, 392.00, 523.25];
      const pattern = [0,1,2,1, 0,1,2,3];
      let step=0;
      this.tid = setInterval(()=>{
        const ct=this.ctx.currentTime;
        while(this.nextTime < ct + this.lookAhead){
          const f = scale[ pattern[ step % pattern.length ] ];
          this.note(this.nextTime, f, 0.16);
          this.nextTime += beat; step++;
        }
      }, 50);
    }
    stop(){
      if(!this.ctx) return;
      this.isOn=false;
      if(this.tid){ clearInterval(this.tid); this.tid=null; }
      try{
        this.gain.gain.cancelScheduledValues(this.ctx.currentTime);
        this.gain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.02);
      }catch(_) {}
    }
  }
  const bgm = new SimpleBGM();

  // ====== ã‚²ãƒ¼ãƒ é€²è¡Œ ======
  btnStart.addEventListener('click', startGame, { passive: true });
  btnQuit .addEventListener('click', resetToTitle, { passive: true });
  btnNext .addEventListener('click', () => { hideOverlay(); nextRound(); }, { passive: true });

  function startGame(){
    round=0; correct=0; answer=0;
    show(scrGame);
    bgm.start();
    nextRound();
  }

  function resetToTitle(){
    bgm.stop();
    hideOverlay(true); // å¼·åˆ¶ã§éš ã™
    round=0; correct=0; answer=0;
    qNow.textContent = 1;
    playArea.querySelectorAll('.cell').forEach(el=>el.remove());
    fxLayer.innerHTML = '';
    enableNumPad(true);
    show(scrTitle);
  }

  function nextRound(){
    hideOverlay(); // å¿µã®ãŸã‚å…ˆã«éš ã™
    round++;
    if(round > TOTAL){ finish(); return; }
    qNow.textContent = round;

    // 1..10
    answer = clamp(Math.floor(Math.random()*10)+1, 1, 10);
    // çµµæŸ„ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆç©ºãªã‚‰ğŸ…ï¼‰
    currentEmoji = (EMOJI_SET && EMOJI_SET.length>0)
      ? EMOJI_SET[Math.floor(Math.random()*EMOJI_SET.length)]
      : 'ğŸ…';

    renderItems(answer);
    enableNumPad(true);
    layoutFit(); // å•é¡Œæç”»å¾Œã«é«˜ã•å†è¨ˆç®—
  }

  function renderItems(n){
    playArea.querySelectorAll('.cell').forEach(el=>el.remove());
    fxLayer.innerHTML = '';

    const rows=4, cols=5;
    let total=toSafeInt(rows*cols, 20);
    if(total<1) total=20; if(total>5000) total=5000;

    const need = Math.min(clamp(toSafeInt(n,1), 0, total), total);
    const cells = Array.from({ length: total }, (_,i)=>i);
    shuffle(cells);
    const picked = cells.slice(0, need);

    for(const idx of picked){
      const r=Math.floor(idx/cols), c=idx%cols;
      const cell=document.createElement('div'); cell.className='cell';
      cell.style.gridRowStart = String(r+1);
      cell.style.gridColumnStart = String(c+1);
      const span=document.createElement('span'); span.className='item'; span.textContent=currentEmoji;
      span.addEventListener('click', ()=> span.classList.toggle('on'), { passive:true });
      cell.appendChild(span); playArea.appendChild(cell);
    }
  }

  // æ•°å­—ãƒœã‚¿ãƒ³ 1..10
  function buildNumPad(){
    numPad.innerHTML = '';
    for(let i=1;i<=10;i++){
      const b=document.createElement('button');
      b.className='nbtn'; b.textContent=i; b.dataset.v=String(i);
      b.addEventListener('click', onAnswer, { passive:true });
      numPad.appendChild(b);
    }
  }
  buildNumPad();

  function enableNumPad(on){
    for(const b of numPad.children){
      b.disabled = !on;
      b.style.opacity = on ? '1' : '.6';
    }
  }

  function onAnswer(e){
    const v = Number(e.currentTarget.dataset.v);
    if(v === answer){
      correct++;
      showCorrect();
    }else{
      giveWrongFeedback();
    }
  }

  function showCorrect(){
    enableNumPad(false);
    overlay.hidden = false;
    overlay.style.display = 'flex';
    celeBox.classList.remove('pop'); void celeBox.offsetWidth; celeBox.classList.add('pop');
    live.textContent = 'ã›ã„ã‹ã„';
    sprinkleConfetti();
  }

  function hideOverlay(force=false){
    overlay.hidden = true;
    overlay.style.display = 'none';
    if(force){ fxLayer.innerHTML = ''; }
  }

  function sprinkleConfetti(){
    const colors = ['#22c55e','#16a34a','#86efac','#f59e0b','#ef4444','#60a5fa'];
    const rect = fxLayer.getBoundingClientRect();
    const count = 24;
    for(let i=0;i<count;i++){
      const d=document.createElement('div');
      d.className='confetti';
      d.style.background = colors[Math.floor(Math.random()*colors.length)];
      d.style.left = (rect.width/2 - 60 + Math.random()*120) + 'px';
      d.style.top  = '20px';
      fxLayer.appendChild(d);
      setTimeout(()=> d.remove(), 800);
    }
  }

  function giveWrongFeedback(){
    numPad.classList.remove('shake'); void numPad.offsetWidth;
    numPad.classList.add('shake');
    if(navigator.vibrate) navigator.vibrate(80);
  }

  function finish(){
    hideOverlay(); // å¿µã®ãŸã‚é–‰ã˜ã‚‹
    show(scrResult);
  }
  scrResult.addEventListener('click', resetToTitle, { passive:true });

  // åˆæœŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  updateSafeVH();
  layoutFit();
  // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾Œã«ã‚‚å†èª¿æ•´ï¼ˆãƒœã‚¿ãƒ³é«˜ã•ãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰
  if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> setTimeout(layoutFit, 0)); }

  // iOS ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æŠ‘åˆ¶ï¼ˆä»»æ„ï¼‰
  document.addEventListener('gesturestart', (e)=>{ try{ e.preventDefault(); }catch(_){} }, { passive:false });
  </script>
</body>
</html>
